services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: "no"
    environment:
      USER_ID: "${USER_ID:?}"
      GROUP_ID: "${GROUP_ID:?}"
      BACKEND_PORT: "${BACKEND_PORT:-3001}"
    depends_on:
      - postgres
    volumes:
      - ./backend:/usr/src/app
    command: npm run start:dev
    networks:
      - default

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      DEV_MODE: "yes"
      WEBSERVER_NAME: "${WEBSERVER_NAME:-nginx}"
      SERVER_PORT: "${SERVER_PORT:-9001}"
      SERVER_PORT_SSL: "${SERVER_PORT_SSL:-9000}"
    volumes:
      - ./frontend:/usr/src/app
    command: [ "yarn", "dev" ]

  postgres:
    image: postgres:17.5
    container_name: "${PROJECT_NAME}-postgres"
    restart: "no"
    environment:
      POSTGRES_USER: "${DB_USERNAME:?Usuário postgres não foi definido}"
      POSTGRES_PASSWORD: "${DB_PASSWORD:?Senha do usuário postgres não foi definida}"
      POSTGRES_DB: "${DB_DATABASE:-dev_database}"
    volumes:
      - ./data/postgres-${BRANCH_NAME:-main}:/var/lib/postgresql/data
    ports:
      - "${DB_PORT_EXTERNAL:-5432}:5432"
    networks:
      - default

  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: "${PROJECT_NAME}-nginx"
    restart: "no"
    ports:
      - "80:80"    # HTTP
      - "81:81"    # Painel NPM
      - "443:443"  # HTTPS
    volumes:
      - ./npm/data:/data
      - ./npm/letsencrypt:/etc/letsencrypt
    networks:
      - default

#  nginx:
#    image: "${PROJECT_NAME}/nginx:${NGINX_IMAGE_VERSION}"
#    build:
#      context: ./nginx
#      dockerfile: Dockerfile
#    container_name: "${PROJECT_NAME}-nginx"
#    restart: "no"
#    environment:
#      NGINX_ENVSUBST_OUTPUT_DIR: "/etc/nginx/sites-enabled"
#      SERVER_HOST: "${SERVER_HOST:-localhost}"
#      SERVER_PORT: "${SERVER_PORT:-9001}"
#      SERVER_PORT_SSL: "${SERVER_PORT_SSL:-9000}"
#    volumes:
#      # Volumes npm
#      -
#      # Volumes de dados
#      - ./nginx/logs:/var/log/nginx
#      # Volumes de configurações
#      - ./nginx/server-conf/nginx.conf:/etc/nginx/nginx.conf
#      - ./nginx/server-conf/conf.d:/etc/nginx/conf.d
#      - ./nginx/server-conf/sites-available:/etc/nginx/sites-available
#      - ./nginx/server-conf/sites-enabled:/etc/nginx/sites-enabled
#      - ./nginx/server-conf/snippets:/etc/nginx/snippets
#      - ./nginx/server-conf/ssl:/etc/nginx/ssl
#      - ./nginx/server-conf/templates/default.conf.template:/etc/nginx/templates/default.conf.template
#    expose:
#      - "${SERVER_PORT:-9001}"
#      - "${SERVER_PORT_SSL:-9000}"
#    ports:
#      - "${SERVER_PORT:-9001}:${SERVER_PORT:-9001}"
#      - "${SERVER_PORT_SSL:-9000}:${SERVER_PORT_SSL:-9000}"
#    command: [ "nginx-debug", "-g", "daemon off;" ]
#    networks:
#      - default

